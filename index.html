<!DOCTYPE html>
<html lang="en">
<head>
    </head>
<body>
    <div id="background-animation"></div>

    <div class="container" id="editor">
        </div>

    <div class="container" id="find-letter-section">
        <h2>Find a Letter</h2>
        <div class="input-group">
            <input type="text" id="search-name" placeholder="Enter your name to search...">
        </div>
        <button class="btn" style="background: #4a4a4a;" onclick="findLetter()">Search Archives</button>
        
        <hr style="margin: 30px 0; border: 1px solid #ffeef1;">
        <h3 style="text-align: center; color: var(--secondary-color); font-family: 'Dancing Script';">Recently Sent To...</h3>
        <div id="public-feed" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            <p style="color: #888; font-size: 0.9rem;">Loading global archives...</p>
        </div>
    </div>

    <div id="letter-display">
       </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, get, query, orderByChild, equalTo, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // TODO: Replace this with your own Firebase Config (I'll explain how below)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL FUNCTIONS ---

        // Make functions globally available to your HTML buttons
        window.saveLetter = async function() {
            const nameInput = document.getElementById('recipient').value;
            const nameSearchable = nameInput.trim().toLowerCase();
            const content = document.getElementById('letter-content').value;
            const song = document.getElementById('song-url').value;
            
            if(!nameInput || !content) return alert("Please enter a name and a message!");
            
            // Get Images (Note: For a real app, storing large images requires Firebase Storage, but this works for tiny images)
            const imgs = [document.getElementById('img-0').src, document.getElementById('img-1').src].filter(src => src.startsWith('data'));

            const newLetter = {
                searchName: nameSearchable,
                displayName: nameInput,
                content: content,
                song: song,
                photos: imgs,
                timestamp: Date.now()
            };

            // Push to Global Database
            try {
                const lettersRef = ref(db, 'letters');
                await push(lettersRef, newLetter);
                alert("Letter Sealed and sent to the global archives! ❤️");
                document.getElementById('editor').classList.add('hidden');
            } catch (error) {
                alert("Error saving letter: " + error.message);
            }
        };

        window.findLetter = async function() {
            const search = document.getElementById('search-name').value.trim().toLowerCase();
            if(!search) return alert("Enter a name first!");

            try {
                const lettersRef = ref(db, 'letters');
                // Search the database for the specific name
                const q = query(lettersRef, orderByChild('searchName'), equalTo(search));
                const snapshot = await get(q);

                if (snapshot.exists()) {
                    // Get the first matching letter
                    const data = Object.values(snapshot.val())[0]; 
                    
                    document.getElementById('find-letter-section').classList.add('hidden');
                    document.getElementById('letter-display').style.display = 'block';
                    
                    document.getElementById('display-to').innerText = "To: " + data.displayName;
                    document.getElementById('display-text').innerText = data.content;
                    
                    // Handle Spotify/YouTube links (Using your existing logic)
                    const musicBox = document.getElementById('music-container');
                    if(data.song && data.song.includes('spotify')) {
                        const id = data.song.split('track/')[1]?.split('?')[0];
                        musicBox.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${id}" width="100%" height="80" frameBorder="0" allow="encrypted-media"></iframe>`;
                    } else if(data.song && data.song.includes('youtube')) {
                        const id = data.song.split('v=')[1]?.split('&')[0];
                        musicBox.innerHTML = `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`;
                    }
                } else {
                    alert("No unsent letters found for this name yet.");
                }
            } catch (error) {
                alert("Error searching: " + error.message);
            }
        };

        // --- LIVE GLOBAL FEED ---
        // This listens to the database and updates the public wall automatically
        const recentLettersRef = query(ref(db, 'letters'), limitToLast(15));
        onValue(recentLettersRef, (snapshot) => {
            const feedContainer = document.getElementById('public-feed');
            feedContainer.innerHTML = ''; // Clear loading text
            
            if (snapshot.exists()) {
                const letters = [];
                snapshot.forEach((child) => { letters.push(child.val()); });
                letters.reverse(); // Show newest first

                letters.forEach(letter => {
                    const tag = document.createElement('span');
                    tag.innerText = letter.displayName;
                    tag.style.cssText = "background: white; padding: 5px 12px; border-radius: 20px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; border: 1px solid #ffeef1; cursor: pointer;";
                    
                    // Clicking a name in the feed automatically searches for it
                    tag.onclick = () => {
                        document.getElementById('search-name').value = letter.displayName;
                        window.findLetter();
                    };
                    
                    feedContainer.appendChild(tag);
                });
            } else {
                feedContainer.innerHTML = '<p style="color: #888;">No letters sent yet. Be the first!</p>';
            }
        });

        // (Keep your existing Heart Animation and Image Preview functions here, just attach them to the window object like: window.triggerUpload = function(...) { ... } )
    </script>
</body>
</html>
